<!DOCTYPE html>
<html lang="es">
<head>
	<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-P3HWK54W');</script>
<!-- End Google Tag Manager -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6JV4GNGRMG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6JV4GNGRMG');
</script>
  <meta charset="UTF-8">
  <title>EmoLex | Clasificador automático del léxico emocional en español</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #f7f9fb;}
    .emolex-section { margin-bottom: 2em; background: #fff; border-radius: 12px; box-shadow: 0 1px 8px #ddd; padding: 2em; }
    .emolex-table { width: 100%; max-width: 820px; border-collapse: collapse; }
    .emolex-table th, .emolex-table td { border: 1px solid #bbb; padding: 0.5em; text-align: left; }
    .align-left { text-align: left !important; }
    #word-select { width: 100%; height: 2.5em; margin-bottom: 1em; font-size: 1em; }
    button { padding: 0.5em 2em; font-size: 1em; background: #1a7fd7; color: #fff; border: none; border-radius: 5px; cursor:pointer;}
    #status { margin-top: 1em; color: #248c3c; font-weight: bold;}
    .warn { color:#a00; font-weight: bold; }
    details { margin-top: 1em; }
    summary { font-weight: bold; }
    .bis-info-tip { font-size: 90%; color:#446;}
    .bis-interpretacion { background: #f6faff; margin-top:1em; border-radius: 5px; padding:1em; font-size: 1.07em;}
    .flex-table-dashboard { display: flex; flex-direction: row; max-width: 1200px; }
    #dashboard-panel { flex:1; margin-left:2em; min-width:400px; max-width:540px; padding:20px 20px; display:flex; flex-direction:column; align-items:center; background:#f7fbff; border-radius:12px; box-shadow:0 1px 6px #ccd;}
    @media (max-width: 900px) {
      .flex-table-dashboard { flex-direction: column !important; }
      #dashboard-panel { margin-left: 0 !important; margin-top: 2em !important; max-width: 100vw; }
    }
    @media (max-width: 700px) {
      .emolex-section { padding: 1em; }
      .emolex-table th, .emolex-table td { font-size: 0.95em; }
      .flex-table-dashboard { padding: 0; }
    }
    .legend-dot {
      display:inline-block;
      width:16px;
      height:16px;
      border-radius: 50%;
      margin-right:6px;
      vertical-align:middle;
    }
    .legend-list { font-size: 1em; margin-top:1em; padding-left:0; }
    .legend-list li { list-style: none; margin:3px 0; }
    .toggle-btn { background:#eee; border-radius:5px; color:#1a7fd7; border:1px solid #bbb; font-weight:bold; padding:2px 18px; margin:2px 0; font-size:1em;}
    .toggle-btn:hover { background:#dbeeff; }
    tbody[data-expanded="false"] tr:nth-child(n+11) { display: none; }
  </style>
  <script src="functions.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
	<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P3HWK54W"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  <div class="emolex-section">
    <h2>EmoLex | Clasificador automático del léxico emocional en español</h2>
    <p>
      Selecciona una palabra y pulsa "Buscar y clasificar" para ver su perfil emocional.<br>
    </p>
  </div>

  <!-- Panel de selección desplegable -->
  <div class="emolex-section">
    <form id="select-form" autocomplete="off">
      <label for="word-select"><b>Selecciona una palabra para su clasificación:</b></label>
      <select id="word-select">
        <option value="">-- Elige una palabra --</option>
      </select>
      <button type="submit">Buscar y clasificar</button>
    </form>
    <div id="select-status"></div>
  </div>

  <div class="emolex-section" id="results-panel" style="display:none;">
    <h3>Resultados</h3>
    <table class="emolex-table">
      <colgroup>
        <col style="width: 15em;">
        <col style="width: 11em;">
        <col style="width: 10em;">
        <col style="width: 13em;">
        <col style="width: 8em;">
        <col style="width: 8em;">
        <col style="width: 10em;">
        <col style="width: 13em;">
        <col style="width: 12em;">
        <col style="width: 12em;">
        <col style="width: 7em;">
        <col style="width: 8em;">
      </colgroup>
      <thead>
        <tr>
          <th>Palabra</th>
          <th>Clúster</th>
          <th>Subclúster</th>
          <th>BIS</th>
          <th>Valencia</th>
          <th>Activación</th>
          <th>Concretud</th>
          <th>Frecuencia (Zipf)</th>
          <th>Emocionalidad</th>
          <th>Emoción dominante</th>
          <th>POS</th>
          <th>F1-score<br>(validación)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="bis-help"></div>
  </div>

  <div class="emolex-section" id="comparative-panel" style="display:none;"></div>

  <script>
    // Paleta Okabe & Ito color-blind friendly
    const chartColors = [
      "#0072B2", // Valencia
      "#E69F00", // Activación
      "#009E73", // Concretud
      "#F0E442", // Frecuencia (Zipf)
      "#CC79A7"  // Emocionalidad
    ];
    const chartLabels = [
      "Valencia", "Activación", "Concretud", "Frecuencia (Zipf)", "Emocionalidad"
    ];

    let LEXICON = {};
    let wordList = [];
    let bisQ1 = null, bisQ3 = null;

    // F1 por subclúster si falta en el JSON
    const F1_by_subcluster = { 1:0.832, 2:0.961, 3:0.943, 4:0.920 };

    fetch('EmoLex.json')
      .then(response => response.json())
      .then(data => {
        LEXICON = {};
        wordList = [];
        const bisVals = [];
        data.forEach(entry => {
          if (!entry || !entry.Word) return;
          const w = entry.Word.toLowerCase();
          LEXICON[w] = entry;
          wordList.push(w);
          const bis = Number(entry.Balanced_Integration_Score);
          if (!isNaN(bis)) bisVals.push(bis);
        });
        bisVals.sort((a, b) => a - b);
        const n = bisVals.length;
        bisQ1 = bisVals[Math.floor(n * 0.25)];
        bisQ3 = bisVals[Math.floor(n * 0.75)];
        populateWordSelect();
      }).catch(err => {
        document.getElementById("select-status").innerHTML =
          `<span class="warn">Error al cargar EmoLex.json</span>`;
        document.getElementById("word-select").disabled = true;
      });

    function populateWordSelect() {
      const select = document.getElementById("word-select");
      wordList.sort().forEach(word => {
        const opt = document.createElement("option");
        opt.value = word;
        opt.textContent = word;
        select.appendChild(opt);
      });
    }

    document.getElementById("select-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const palabra = document.getElementById("word-select").value;
      const status = document.getElementById("select-status");
      status.textContent = "";
      if (!palabra) {
        status.innerHTML = '<span class="warn">Debes seleccionar una palabra.</span>';
        clearTable();
        return;
      }
      if (LEXICON[palabra]) {
        const result = classifyWords([palabra]);
        renderResults(result);
        buildComparativeTable(palabra);
        document.getElementById("results-panel").style.display = "block";
      } else {
        renderResults([{
          Word: palabra,
          Cluster: "No clasificada",
          "Sub-Cluster": "No clasificada",
          Balanced_Integration_Score: "",
          Valence_Mean: "",
          Arousal_Mean: "",
          Concreteness_Mean: "",
          Zipf_EsPal: "",
          Emotionality: "",
          Dominant_emotion: "",
          POS: "",
          F1: "",
          found: false
        }]);
        document.getElementById("results-panel").style.display = "block";
        document.getElementById("comparative-panel").style.display = "none";
        status.innerHTML = `<span class="warn">Palabra no encontrada. Solo se pueden clasificar palabras presentes en el léxico.</span>`;
      }
    });

    function classifyWords(words) {
      return words.map(word => {
        const key = word.toLowerCase();
        const entry = LEXICON[key];
        if (entry) {
          let f1 = entry.F1;
          if ((typeof f1 === "undefined" || f1 === "" || f1 === null) && F1_by_subcluster && entry["Sub-Cluster"]) {
            f1 = F1_by_subcluster[entry["Sub-Cluster"]] ?? "";
          }
          return {
            Word: word,
            Cluster: entry.Cluster ?? "N/A",
            "Sub-Cluster": entry["Sub-Cluster"] ?? "N/A",
            Balanced_Integration_Score: entry.Balanced_Integration_Score ?? "",
            Valence_Mean: entry.Valence_Mean ?? "",
            Arousal_Mean: entry.Arousal_Mean ?? "",
            Concreteness_Mean: entry.Concreteness_Mean ?? "",
            Zipf_EsPal: entry.Zipf_EsPal ?? "",
            Emotionality: entry.Emotionality ?? "",
            Dominant_emotion: entry.Dominant_emotion ?? "",
            POS: entry.POS ?? "",
            F1: f1,
            found: true
          };
        } else {
          return {
            Word: word,
            Cluster: "No clasificada",
            "Sub-Cluster": "No clasificada",
            Balanced_Integration_Score: "",
            Valence_Mean: "",
            Arousal_Mean: "",
            Concreteness_Mean: "",
            Zipf_EsPal: "",
            Emotionality: "",
            Dominant_emotion: "",
            POS: "",
            F1: "",
            found: false
          };
        }
      });
    }

    function renderResults(results) {
      const tbody = document.querySelector(".emolex-table tbody");
      tbody.innerHTML = "";
      for (const r of results) {
        const tr = document.createElement("tr");
        if (!r.found) {
          tr.innerHTML = `
            <td colspan="12" class="warn">
              "${r.Word}": Palabra no encontrada en la base léxica. No puede ser clasificada automáticamente.
            </td>
          `;
          tr.style.background = "#fbeaea";
        } else {
          tr.innerHTML = `
            <td>${r.Word}</td>
            <td>${r.Cluster}</td>
            <td>${r["Sub-Cluster"]}</td>
            <td>${typeof r.Balanced_Integration_Score === "number"
                    ? r.Balanced_Integration_Score.toFixed(15)
                    : r.Balanced_Integration_Score}</td>
            <td>${r.Valence_Mean}</td>
            <td>${r.Arousal_Mean}</td>
            <td>${r.Concreteness_Mean}</td>
            <td>${r.Zipf_EsPal}</td>
            <td>${r.Emotionality}</td>
            <td>${r.Dominant_emotion}</td>
            <td>${r.POS}</td>
            <td>${typeof r.F1 === "number"
                    ? r.F1.toFixed(3)
                    : (r.F1 ?? "")}</td>
          `;
          // Panel BIS dinámico por palabra seleccionada
          renderBISInterpretation(
            typeof r.Balanced_Integration_Score === "number" ? r.Balanced_Integration_Score : Number(r.Balanced_Integration_Score),
            r.Word,
            r.Dominant_emotion
          );
        }
        tbody.appendChild(tr);
      }
    }

    // Panel interpretación BIS (dinámico con percentiles)
    function renderBISInterpretation(BIS, word, emotion) {
      const helpDiv = document.getElementById("bis-help");
      if (typeof BIS === "undefined" || BIS === "" || bisQ1 === null || bisQ3 === null) {
        helpDiv.innerHTML = "";
        return;
      }
      let interpretacion = "";
      if (BIS <= bisQ1) {
        interpretacion = `<strong>BIS bajo:</strong> “${word}” es atípica y menos representativa del grupo emocional (<b>${emotion}</b>).<br>
        Requiere apoyo contextual y ejemplos concretos de uso para su enseñanza.
		<small>Las palabras con BIS igual o inferior al percentil 25 (Q1, primer cuartil) son clasificadas como “BIS bajo” (menos prototípicas o más atípicas).</small>`;
      } else if (BIS >= bisQ3) {
        interpretacion = `<strong>BIS alto:</strong> “${word}” es altamente prototípica en su grupo emocional (<b>${emotion}</b>).<br>
        Facilita el acceso rápido a significados afectivo-semánticos y la enseñanza del léxico en el reconocimiento de emociones.
		<small>Las palabras con BIS igual o superior a Q3 son clasificadas como “BIS alto” (más prototípicas dentro del clúster).</small>`;
      } else {
        interpretacion = `<strong>BIS medio:</strong> “${word}” ocupa una posición intermedia de representatividad en su grupo emocional (<b>${emotion}</b>).<br>
        Es de utilidad para la enseñanza de matices afectivo-semánticos del léxico extendido a contextos particulares de uso.
		<small>Las palabras cuyo BIS se encuentra entre el intervalo intercuartil (Q1 < BIS < Q3) se consideran de “BIS medio” (nivel intermedio de representatividad).</small>`;
      }
      helpDiv.innerHTML = `<div class="bis-interpretacion"><em>¿Cómo se interpreta el índice BIS?</em> ${interpretacion}</div>`;
    }

    // buildComparativeTable y dashboard como antes
    function mean(arr) { return typeof functions !== "undefined" && functions.mean ? functions.mean(arr) : (arr.length ? arr.reduce((a,b) => a+b,0)/arr.length : 0); }
    function sd(arr)   { return typeof functions !== "undefined" && functions.sd   ? functions.sd(arr)   : (arr.length ? Math.sqrt(arr.reduce((a,b)=>a+Math.pow(b-mean(arr),2),0)/arr.length) : 0); }

    function buildComparativeTable(selectedWord) {
      const panel = document.getElementById("comparative-panel");
      const dashboard = document.getElementById("dashboard-panel");
      if (!selectedWord || !LEXICON[selectedWord.toLowerCase()]) {
        panel.innerHTML = '';
        panel.style.display = "none";
        if (dashboard) dashboard.innerHTML = '';
        return;
      }
      try {
        const entry = LEXICON[selectedWord.toLowerCase()];
        const cluster = entry.Cluster;
        const subcluster = entry["Sub-Cluster"];
        let clusterWords = {};
        Object.values(LEXICON).forEach(e => {
          if (e.Cluster == cluster) {
            const sc = e["Sub-Cluster"];
            if (!clusterWords[sc]) clusterWords[sc] = [];
            clusterWords[sc].push(e);
          }
        });

        // Ordena palabras de cada subclúster alfabéticamente
        Object.values(clusterWords).forEach(arr => {
          arr.sort((a, b) => a.Word.localeCompare(b.Word));
        });

        let html = `<div class="flex-table-dashboard">
          <div style="flex:2;">
            <h4>Comparación de prototipicidad emocional (BIS) en clúster ${cluster}</h4>
            <table class="emolex-table" style="width:100%; max-width:820px;">
              <colgroup>
                <col style="width: 10em;">
                <col style="width: 18em;">
                <col style="width: 18em;">
              </colgroup>
              <thead>
                <tr>
                  <th class="align-left">Subclúster</th>
                  <th class="align-left">Palabra</th>
                  <th class="align-left">BIS</th>
                </tr>
              </thead>`;

        Object.entries(clusterWords).forEach(([sc, arr], idx) => {
          const subclusterId = `sc${sc}`;
          html += `<tbody id="tbody-${subclusterId}" data-expanded="false">`;
          arr.slice(0, 10).forEach(e => {
            html += `<tr${sc == subcluster ? ' style="background:#e8f8e1;"' : ''}>
              <td class="align-left">${sc}</td>
              <td class="align-left" style="cursor:pointer;"
                  onclick="showDashboard('${e.Word.replace(/'/g,"\\'")}')">${e.Word}</td>
              <td class="align-left">${typeof e.Balanced_Integration_Score === "number"
                      ? e.Balanced_Integration_Score.toFixed(15)
                      : e.Balanced_Integration_Score}</td>
            </tr>`;
          });
          html += `</tbody>`;
          if (arr.length > 10) {
            html += `
              <tfoot id="tfoot-${subclusterId}">
                <tr>
                  <td colspan="3" style="text-align:center;">
                    <button class="toggle-btn" type="button"
                      onclick="toggleSubcluster('${subclusterId}', ${arr.length})">
                      Mostrar más (${arr.length - 10} más)
                    </button>
                  </td>
                </tr>
              </tfoot>
            `;
          }
          window[`words_${subclusterId}`] = arr;
        });
        html += "</table>";

        // Comparativo estadístico entre subclústeres (Cohen’s d, Hedges’ g)
		let comparativo = '';
		if (typeof functions !== "undefined") {
		  const arrSel = (clusterWords[subcluster] || []).map(e => Number(e.Balanced_Integration_Score)).filter(x=>!isNaN(x));
		  Object.keys(clusterWords).forEach(sc => {
			if (String(sc) !== String(subcluster)) {
			  const arrOth = clusterWords[sc].map(e => Number(e.Balanced_Integration_Score)).filter(x=>!isNaN(x));
			  const m1 = mean(arrSel), m2 = mean(arrOth);
			  const s1 = sd(arrSel), s2 = sd(arrOth);
			  const n1 = arrSel.length, n2 = arrOth.length;
			  const sd_pooled = functions.sdpooled(s1, n1, s2, n2);
			  const d = (m1 - m2) / sd_pooled;
			  const v  = functions.vd(d, n1, n2);
			  const g  = functions.gfromd(d, n1, n2);
			  const vg = functions.vgfromvd(v, n1, n2);
			  const lower = functions.lower_d(d, v);
			  const upper = functions.upper_d(d, v);
			  const lower_g = functions.lower_d(g, vg);
			  const upper_g = functions.upper_d(g, vg);
			  let sentido = d > 0 ? 
				"El subclúster seleccionado muestra mayor prototipicidad emocional promedio." : 
				"El subclúster comparado muestra mayor prototipicidad emocional promedio.";
			  comparativo += `<div style="margin:0.5em 0 1em 0; border-left: 3px solid #a7cae3; padding-left: 1em;">
				<b>Comparación ${subcluster} vs ${sc}:</b><br>
				Cohen’s d = ${d.toFixed(3)}, IC 95%: [${lower.toFixed(3)}, ${upper.toFixed(3)}]<br>
				Hedges’ g = ${g.toFixed(3)}, IC 95%: [${lower_g.toFixed(3)}, ${upper_g.toFixed(3)}]<br>
				<span style="font-size:95%">${sentido}</span>
			  </div>`;
			}
		  });
		}
        html += comparativo;
        html += `</div>`; // Cierra flex:2
        html += `<div id="dashboard-panel" style="flex:1; margin-left:2em; min-width:400px; max-width:540px; padding:20px 20px; display:flex; flex-direction:column; align-items:center; background:#f7fbff; border-radius:12px; box-shadow:0 1px 6px #ccd;"></div></div>`;

        panel.innerHTML = html;
        panel.style.display = "block";
        showDashboard(selectedWord);

      } catch (err) {
        panel.innerHTML = '';
        panel.style.display = "none";
        const dashboard = document.getElementById("dashboard-panel");
        if (dashboard) dashboard.innerHTML = '';
      }
    }

    window.toggleSubcluster = function(subclusterId, total) {
      const tbody = document.getElementById('tbody-' + subclusterId);
      const tfoot = document.getElementById('tfoot-' + subclusterId);
      const arr = window[`words_${subclusterId}`];
      if (!tbody || !tfoot || !arr) return;
      const expanded = tbody.getAttribute('data-expanded') === "true";
      tbody.innerHTML = '';
      if (expanded) {
        arr.slice(0, 10).forEach(e => {
          tbody.innerHTML += `<tr>
            <td class="align-left">${subclusterId.replace("sc","")}</td>
            <td class="align-left" style="cursor:pointer;"
                onclick="showDashboard('${e.Word.replace(/'/g,"\\'")}')">${e.Word}</td>
            <td class="align-left">${typeof e.Balanced_Integration_Score === "number"
                    ? e.Balanced_Integration_Score.toFixed(15)
                    : e.Balanced_Integration_Score}</td>
          </tr>`;
        });
        tfoot.querySelector('button').textContent = `Mostrar más (${arr.length - 10} más)`;
        tbody.setAttribute('data-expanded', "false");
      } else {
        arr.forEach(e => {
          tbody.innerHTML += `<tr>
            <td class="align-left">${subclusterId.replace("sc","")}</td>
            <td class="align-left" style="cursor:pointer;"
                onclick="showDashboard('${e.Word.replace(/'/g,"\\'")}')">${e.Word}</td>
            <td class="align-left">${typeof e.Balanced_Integration_Score === "number"
                    ? e.Balanced_Integration_Score.toFixed(15)
                    : e.Balanced_Integration_Score}</td>
          </tr>`;
        });
        tfoot.querySelector('button').textContent = "Mostrar menos";
        tbody.setAttribute('data-expanded', "true");
      }
    }

    function showDashboard(word) {
      const entry = LEXICON[word.toLowerCase()];
      const dashboard = document.getElementById("dashboard-panel");
      if (!entry || !dashboard) { if (dashboard) dashboard.innerHTML = ""; return; }
      dashboard.innerHTML = `
        <h4 style="margin:0 0 0.7em 0; text-align:center;">${entry.Word}</h4>
        <canvas id="chartjs-dashboard" width="390" height="390" style="display:block; margin-bottom:1.1em;"></canvas>
        <ul class="legend-list" style="margin:0 auto 0.8em auto; max-width:320px;">
          <li><span class="legend-dot" style="background:#0072B2"></span>Valencia</li>
          <li><span class="legend-dot" style="background:#E69F00"></span>Activación</li>
          <li><span class="legend-dot" style="background:#009E73"></span>Concretud</li>
          <li><span class="legend-dot" style="background:#F0E442"></span>Frecuencia (Zipf)</li>
          <li><span class="legend-dot" style="background:#CC79A7"></span>Emocionalidad</li>
        </ul>
        <div style="margin:0.4em 0 0 0; font-size:1.04em;">
          <p style="margin:0.3em 0 0.2em 0;"><b>Emoción dominante:</b> ${entry.Dominant_emotion ?? "–"}</p>
          <p style="margin:0.2em 0;"><b>POS:</b> ${entry.POS ?? "–"}</p>
        </div>
      `;
      const data = [
        entry.Valence_Mean ?? 0,
        entry.Arousal_Mean ?? 0,
        entry.Concreteness_Mean ?? 0,
        entry.Zipf_EsPal ?? 0,
        entry.Emotionality ?? 0
      ];
      const config = {
        type: 'radar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Perfil léxico-emocional',
            data: data,
            fill: true,
            backgroundColor: "rgba(0,114,178,0.09)",
            borderColor: "#333",
            borderWidth: 2,
            pointBackgroundColor: chartColors,
            pointBorderColor: "#fff",
            pointRadius: 8,
            pointHoverBackgroundColor: "#fff",
            pointHoverBorderColor: chartColors
          }]
        },
        options: {
          plugins: { legend: { display: false }},
          layout: { padding: 18 },
          scales: {
            r: {
              min: 0,
              max: 8,
              angleLines: { color: "#bbb" },
              grid: { color: "#e0e0e0" },
              pointLabels: {
                color: chartColors,
                font: { size: 17, weight: "bold" },
                padding: 18
              },
              ticks: {
                color: "#333",
                backdropColor: "#f7fbff",
                stepSize: 2,
                font: { size: 13 }
              }
            }
          }
        }
      };
      if (window.chartjsDashboard) window.chartjsDashboard.destroy();
      window.chartjsDashboard = new Chart(
        document.getElementById('chartjs-dashboard'),
        config
      );
    }
  </script>
  <footer style="text-align:center; margin:3em 0 0 0; color:#888; font-size:0.96em;">
    &copy; 2025 LingTropy&nbsp;|&nbsp;Dr. Marcos H. Cárdenas Mancilla
  </footer>
</body>
</html>



